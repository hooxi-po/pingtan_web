import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'

// 缓存配置
const CACHE_DURATION = 5 * 60 * 1000 // 5分钟缓存
let cachedData: any = null
let cacheTimestamp = 0

/**
 * GET /api/accommodations
 * 获取住宿列表，支持搜索和筛选
 */
export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url)
    const searchQuery = searchParams.get('search') || ''
    const type = searchParams.get('type') || 'all'
    const location = searchParams.get('location') || 'all'
    const priceRange = searchParams.get('priceRange') || 'all'
    const sortBy = searchParams.get('sortBy') || 'rating'
    const limit = parseInt(searchParams.get('limit') || '20')
    const offset = parseInt(searchParams.get('offset') || '0')

    // 如果没有筛选条件且在缓存有效期内，返回缓存数据
    const hasFilters = searchQuery || type !== 'all' || location !== 'all' || priceRange !== 'all' || offset > 0
    const now = Date.now()
    
    if (!hasFilters && cachedData && (now - cacheTimestamp) < CACHE_DURATION) {
      return NextResponse.json(cachedData)
    }

    // 构建查询条件
    const where: any = {
      isActive: true
    }

    // 搜索条件
    if (searchQuery) {
      where.OR = [
        { name: { contains: searchQuery, mode: 'insensitive' } },
        { description: { contains: searchQuery, mode: 'insensitive' } },
        { address: { contains: searchQuery, mode: 'insensitive' } }
      ]
    }

    // 类型筛选
    if (type !== 'all') {
      where.type = type.toUpperCase()
    }

    // 位置筛选（基于地址）
    if (location !== 'all') {
      where.address = { contains: location, mode: 'insensitive' }
    }

    // 价格范围筛选
    if (priceRange !== 'all') {
      where.priceRange = priceRange
    }

    // 排序条件
    let orderBy: any = {}
    switch (sortBy) {
      case 'price-low':
        orderBy = { priceRange: 'asc' }
        break
      case 'price-high':
        orderBy = { priceRange: 'desc' }
        break
      case 'rating':
        orderBy = { rating: 'desc' }
        break
      case 'popular':
        orderBy = { reviewCount: 'desc' }
        break
      default:
        orderBy = { rating: 'desc' }
    }

    // 优化的数据库查询 - 只选择必要字段
    const accommodations = await prisma.accommodation.findMany({
      where,
      orderBy,
      take: limit,
      skip: offset,
      select: {
        id: true,
        name: true,
        description: true,
        type: true,
        address: true,
        images: true,
        amenities: true,
        roomTypes: true, // roomTypes是Json[]类型，直接选择
        priceRange: true,
        rating: true,
        reviewCount: true,
        contactPhone: true,
        contactEmail: true,
        checkInTime: true,
        checkOutTime: true,
        policies: true
      }
    })

    // 并行查询总数（仅在需要时）
    const totalPromise = hasFilters ? prisma.accommodation.count({ where }) : Promise.resolve(accommodations.length)
    const total = await totalPromise

    // 转换数据格式以兼容前端
    const formattedAccommodations = accommodations.map(acc => ({
      id: acc.id,
      name: acc.name,
      description: acc.description,
      type: acc.type.toLowerCase(),
      location: acc.address,
      address: acc.address,
      images: acc.images || [],
      amenities: acc.amenities || [],
      roomTypes: acc.roomTypes || [],
      priceRange: acc.priceRange,
      rating: acc.rating,
      reviews: acc.reviewCount,
      reviewCount: acc.reviewCount,
      contactPhone: acc.contactPhone,
      contactEmail: acc.contactEmail,
      checkInTime: acc.checkInTime,
      checkOutTime: acc.checkOutTime,
      policies: acc.policies,
      // 兼容旧格式
      price: getPriceFromRange(acc.priceRange),
      popular: acc.reviewCount > 100,
      features: acc.amenities?.slice(0, 4) || [],
      maxGuests: getRoomCapacity(acc.roomTypes),
      bedrooms: getRoomCount(acc.roomTypes),
      category: getCategoryFromType(acc.type),
      // 添加图片字段兼容
      image: acc.images?.[0] || 'https://images.unsplash.com/photo-1555854877-bab0e564b8d5?w=800'
    }))

    const result = {
      data: formattedAccommodations,
      pagination: {
        total,
        limit,
        offset,
        hasMore: offset + limit < total
      }
    }

    // 缓存无筛选条件的结果
    if (!hasFilters) {
      cachedData = result
      cacheTimestamp = Date.now()
    }

    return NextResponse.json(result)

  } catch (error) {
    console.error('获取住宿列表失败:', error)
    return NextResponse.json(
      { error: '获取住宿列表失败' },
      { status: 500 }
    )
  }
}

// 辅助函数：从价格范围获取数字价格
function getPriceFromRange(priceRange: string): number {
  const priceMap: { [key: string]: number } = {
    '经济': 168,
    '中档': 288,
    '中高档': 428,
    '高档': 588,
    '豪华': 888
  }
  return priceMap[priceRange] || 288
}

// 辅助函数：从房型数据获取最大容量
function getRoomCapacity(roomTypes: any[]): number {
  if (!roomTypes || roomTypes.length === 0) return 2
  const maxCapacity = Math.max(...roomTypes.map((room: any) => room.maxGuests || 2))
  return maxCapacity
}

// 辅助函数：从房型数据获取房间数
function getRoomCount(roomTypes: any[]): number {
  if (!roomTypes || roomTypes.length === 0) return 1
  return roomTypes.length
}

// 辅助函数：从类型获取分类
function getCategoryFromType(type: string): string {
  const categoryMap: { [key: string]: string } = {
    'HOTEL': '商务出行',
    'RESORT': '度假休闲',
    'GUESTHOUSE': '民俗体验',
    'HOSTEL': '经济住宿',
    'VILLA': '奢华度假',
    'APARTMENT': '家庭度假',
    'BOUTIQUE': '文化体验'
  }
  return categoryMap[type.toUpperCase()] || '住宿体验'
}