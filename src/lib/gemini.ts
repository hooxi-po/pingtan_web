import { GoogleGenerativeAI } from '@google/generative-ai';

// åˆå§‹åŒ– Gemini AI
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '');

// è·å–æ¨¡å‹å®ä¾‹
const model = genAI.getGenerativeModel({ 
  model: process.env.GEMINI_MODEL || 'gemini-1.5-flash' 
});

// Gemini AI æœåŠ¡ç±»
export class GeminiService {
  /**
   * ç”ŸæˆAIå›å¤
   * @param message ç”¨æˆ·æ¶ˆæ¯
   * @param context ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
   * @returns AIå›å¤å†…å®¹
   */
  static async generateResponse(
    message: string, 
    context?: string
  ): Promise<string> {
    try {
      // æ£€æŸ¥APIå¯†é’¥æ˜¯å¦å­˜åœ¨
      if (!process.env.GEMINI_API_KEY) {
        console.error('GEMINI_API_KEY æœªé…ç½®');
        return this.getFallbackResponse(message);
      }

      // æ„å»ºç³»ç»Ÿæç¤ºè¯ï¼Œç¡®ä¿å›å¤ä¸ºä¸­æ–‡
      const systemPrompt = `ä½ æ˜¯å¹³æ½­æ—…æ¸¸æ™ºèƒ½åŠ©æ‰‹ï¼Œä¸“é—¨ä¸ºæ¸¸å®¢æä¾›å¹³æ½­å²›çš„æ—…æ¸¸å’¨è¯¢æœåŠ¡ã€‚è¯·ç”¨ä¸­æ–‡å›ç­”æ‰€æœ‰é—®é¢˜ã€‚

ä½ çš„èŒè´£åŒ…æ‹¬ï¼š
1. æ¨èå¹³æ½­çš„æ™¯ç‚¹ã€ç¾é£Ÿã€ä½å®¿
2. æä¾›äº¤é€šæŒ‡å—å’Œæ—…æ¸¸è·¯çº¿å»ºè®®
3. ä»‹ç»å¹³æ½­çš„æ–‡åŒ–ç‰¹è‰²å’Œå†å²èƒŒæ™¯
4. å›ç­”å…³äºå¤©æ°”ã€æœ€ä½³æ—…æ¸¸æ—¶é—´ç­‰å®ç”¨ä¿¡æ¯
5. æä¾›æ—…æ¸¸æ³¨æ„äº‹é¡¹å’Œå®‰å…¨æé†’

è¯·ä¿æŒå‹å¥½ã€ä¸“ä¸šçš„è¯­è°ƒï¼Œæä¾›å‡†ç¡®ã€å®ç”¨çš„ä¿¡æ¯ã€‚æ‰€æœ‰å›å¤å¿…é¡»ä½¿ç”¨ä¸­æ–‡ã€‚`;

      // æ„å»ºå®Œæ•´çš„æç¤ºè¯
      let fullPrompt = systemPrompt;
      
      if (context) {
        fullPrompt += `\n\nä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š${context}`;
      }
      
      fullPrompt += `\n\nç”¨æˆ·é—®é¢˜ï¼š${message}`;

      // è°ƒç”¨ Gemini API
      const result = await model.generateContent(fullPrompt);
      const response = await result.response;
      const text = response.text();

      return text || 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚';
    } catch (error) {
      console.error('Gemini API è°ƒç”¨å¤±è´¥:', error);
      console.error('é”™è¯¯è¯¦æƒ…:', {
        message: (error as any)?.message,
        stack: (error as any)?.stack,
        apiKey: process.env.GEMINI_API_KEY ? 'å·²é…ç½®' : 'æœªé…ç½®'
      });
      
      // è¿”å›å›é€€å“åº”
      return this.getFallbackResponse(message);
    }
  }

  /**
   * è·å–å›é€€å“åº”ï¼ˆå½“Gemini APIä¸å¯ç”¨æ—¶ï¼‰
   * @param message ç”¨æˆ·æ¶ˆæ¯
   * @returns å›é€€å“åº”å†…å®¹
   */
  private static getFallbackResponse(message: string): string {
    const lowerMessage = message.toLowerCase();
    
    // æ™¯ç‚¹æ¨è
    if (lowerMessage.includes('æ™¯ç‚¹') || lowerMessage.includes('æ¨è') || lowerMessage.includes('ç©')) {
      return 'ğŸ–ï¸ **å¹³æ½­çƒ­é—¨æ™¯ç‚¹æ¨èï¼š**\n\nâ€¢ **å›å—æ¹¾æµ·æ»¨æµ´åœº** - ç¾ä¸½çš„æ²™æ»©å’Œæ¸…æ¾ˆæµ·æ°´\nâ€¢ **çŸ³ç‰Œæ´‹** - è‘—åçš„æµ·ä¸ŠåŒçŸ³æŸ±å¥‡è§‚\nâ€¢ **é¾™å‡¤å¤´æµ·æ»¨æµ´åœº** - é€‚åˆæ¸¸æ³³å’Œæ°´ä¸Šè¿åŠ¨\nâ€¢ **åŒ—æ¸¯æ‘** - æ–‡è‰ºå°æ‘åº„ï¼Œç½‘çº¢æ‰“å¡åœ°\nâ€¢ **çŒ´ç ”å²›** - åŸç”Ÿæ€æµ·å²›é£å…‰\nâ€¢ **ä¸œæµ·ä»™å¢ƒ** - å£®è§‚çš„æµ·èš€åœ°è²Œ\n\néœ€è¦äº†è§£å…·ä½“æ™¯ç‚¹çš„è¯¦ç»†ä¿¡æ¯å—ï¼Ÿ';
    }
    
    // ç¾é£Ÿæ¨è
    if (lowerMessage.includes('ç¾é£Ÿ') || lowerMessage.includes('åƒ') || lowerMessage.includes('ç‰¹è‰²')) {
      return 'ğŸ½ï¸ **å¹³æ½­ç‰¹è‰²ç¾é£Ÿï¼š**\n\nâ€¢ **æ—¶æ¥è¿è½¬** - å¹³æ½­ä¼ ç»Ÿå°é£Ÿ\nâ€¢ **æµ·è›é¥¼** - é…¥è„†å¯å£çš„æµ·é²œç…é¥¼\nâ€¢ **é±¼ä¸¸** - æ–°é²œæµ·é±¼åˆ¶ä½œ\nâ€¢ **ç´«èœ** - å¹³æ½­ä¼˜è´¨ç´«èœ\nâ€¢ **æµ·é²œå¤§é¤** - å„ç§æ–°é²œæµ·äº§\nâ€¢ **èŠ±ç”Ÿæ±¤** - å½“åœ°ç‰¹è‰²ç”œå“\n\næƒ³äº†è§£å“ªç§ç¾é£Ÿçš„åˆ¶ä½œæ–¹æ³•æˆ–æ¨èé¤å…å—ï¼Ÿ';
    }
    
    // ä½å®¿æ¨è
    if (lowerMessage.includes('ä½å®¿') || lowerMessage.includes('æ°‘å®¿') || lowerMessage.includes('é…’åº—')) {
      return 'ğŸ  **å¹³æ½­ä½å®¿æ¨èï¼š**\n\nâ€¢ **æµ·æ™¯æ°‘å®¿** - é¢æœå¤§æµ·ï¼Œæ˜¥æš–èŠ±å¼€\nâ€¢ **åŒ—æ¸¯æ‘æ°‘å®¿** - æ–‡è‰ºèŒƒåè¶³\nâ€¢ **åº¦å‡é…’åº—** - è®¾æ–½å®Œå–„ï¼ŒæœåŠ¡ä¼˜è´¨\nâ€¢ **æ¸”å®¶ä¹** - ä½“éªŒå½“åœ°æ¸”æ°‘ç”Ÿæ´»\nâ€¢ **é’å¹´æ—…ç¤¾** - ç»æµå®æƒ ï¼Œé€‚åˆèƒŒåŒ…å®¢\n\néœ€è¦æˆ‘ä¸ºæ‚¨æ¨èå…·ä½“çš„ä½å®¿åœ°ç‚¹å—ï¼Ÿ';
    }
    
    // äº¤é€šä¿¡æ¯
    if (lowerMessage.includes('äº¤é€š') || lowerMessage.includes('æ€ä¹ˆå»') || lowerMessage.includes('è·¯çº¿')) {
      return 'ğŸš— **å¹³æ½­äº¤é€šæŒ‡å—ï¼š**\n\n**åˆ°è¾¾å¹³æ½­ï¼š**\nâ€¢ é£æœºï¼šç¦å·é•¿ä¹æœºåœº â†’ å¹³æ½­ï¼ˆçº¦1.5å°æ—¶ï¼‰\nâ€¢ é«˜é“ï¼šç¦å·ç«™/ç¦å·å—ç«™ â†’ å¹³æ½­ï¼ˆçº¦2å°æ—¶ï¼‰\nâ€¢ è‡ªé©¾ï¼šç»å¹³æ½­æµ·å³¡å¤§æ¡¥ç›´è¾¾\n\n**å²›å†…äº¤é€šï¼š**\nâ€¢ ç§Ÿè½¦è‡ªé©¾ï¼ˆæ¨èï¼‰\nâ€¢ åŒ…è½¦æ¸¸è§ˆ\nâ€¢ å…¬äº¤è½¦\nâ€¢ ç”µåŠ¨è½¦ç§Ÿèµ\n\néœ€è¦å…·ä½“çš„è·¯çº¿è§„åˆ’å—ï¼Ÿ';
    }
    
    // å¤©æ°”ä¿¡æ¯
    if (lowerMessage.includes('å¤©æ°”')) {
      return 'ğŸŒ¤ï¸ **å¹³æ½­æ°”å€™ç‰¹ç‚¹ï¼š**\n\nâ€¢ **æ˜¥å­£ï¼ˆ3-5æœˆï¼‰**ï¼šæ¸©å’Œèˆ’é€‚ï¼Œé€‚åˆæ—…æ¸¸\nâ€¢ **å¤å­£ï¼ˆ6-8æœˆï¼‰**ï¼šé€‚åˆæµ·æ»©æ´»åŠ¨ï¼Œæ³¨æ„é˜²æ™’\nâ€¢ **ç§‹å­£ï¼ˆ9-11æœˆï¼‰**ï¼šæœ€ä½³æ—…æ¸¸å­£èŠ‚\nâ€¢ **å†¬å­£ï¼ˆ12-2æœˆï¼‰**ï¼šç›¸å¯¹è¾ƒå†·ï¼Œä½†æµ·æ™¯ä¾ç„¶ç¾ä¸½\n\nå»ºè®®å‡ºè¡Œå‰æŸ¥çœ‹æœ€æ–°å¤©æ°”é¢„æŠ¥å“¦ï¼';
    }
    
    // é»˜è®¤å›å¤
    return 'ğŸ‘‹ **æ¬¢è¿æ¥åˆ°å¹³æ½­ï¼**\n\næˆ‘æ˜¯æ‚¨çš„æ—…æ¸¸åŠ©æ‰‹ï¼Œå¯ä»¥ä¸ºæ‚¨æä¾›ï¼š\n\nğŸ–ï¸ **æ™¯ç‚¹æ¨è** - å‘ç°å¹³æ½­æœ€ç¾çš„åœ°æ–¹\nğŸ  **ä½å®¿å»ºè®®** - å¯»æ‰¾å¿ƒä»ªçš„è½è„šç‚¹\nğŸ½ï¸ **ç¾é£ŸæŒ‡å—** - å“å°åœ°é“ç‰¹è‰²\nğŸ“… **è¡Œç¨‹è§„åˆ’** - åˆ¶å®šå®Œç¾æ—…ç¨‹\nğŸŒ¤ï¸ **å®ç”¨ä¿¡æ¯** - å¤©æ°”äº¤é€šç­‰\n\nè¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Œæˆ‘ä¼šå°½åŠ›å¸®åŠ©æ‚¨ï¼\n\n*æ³¨ï¼šæ™ºèƒ½åŠ©æ‰‹æ­£åœ¨å‡çº§ä¸­ï¼Œå¦‚æœ‰ä¸ä¾¿æ•¬è¯·è°…è§£ã€‚*';
  }

  /**
   * ç”Ÿæˆæ™¯ç‚¹æ¨è
   * @param preferences ç”¨æˆ·åå¥½
   * @returns æ™¯ç‚¹æ¨èå†…å®¹
   */
  static async generateAttractionRecommendation(
    preferences?: string
  ): Promise<string> {
    const context = `å¹³æ½­ä¸»è¦æ™¯ç‚¹åŒ…æ‹¬ï¼š
- å›å—æ¹¾æµ·æ»¨æµ´åœºï¼šç¾ä¸½çš„æ²™æ»©å’Œæµ·æ™¯
- çŸ³ç‰Œæ´‹ï¼šè‘—åçš„æµ·ä¸ŠçŸ³æŸ±æ™¯è§‚
- é¾™å‡¤å¤´æµ·æ»¨æµ´åœºï¼šé€‚åˆæ¸¸æ³³å’Œæ°´ä¸Šè¿åŠ¨
- åŒ—æ¸¯æ‘ï¼šæ–‡è‰ºå°æ‘åº„ï¼Œé€‚åˆæ‹ç…§
- çŒ´ç ”å²›ï¼šåŸç”Ÿæ€æµ·å²›é£å…‰
- ä¸œæµ·ä»™å¢ƒï¼šå£®è§‚çš„æµ·èš€åœ°è²Œ`;
    
    const message = preferences 
      ? `è¯·æ ¹æ®æˆ‘çš„åå¥½æ¨èå¹³æ½­æ™¯ç‚¹ï¼š${preferences}`
      : 'è¯·æ¨èå¹³æ½­çš„çƒ­é—¨æ™¯ç‚¹';
    
    return this.generateResponse(message, context);
  }

  /**
   * ç”Ÿæˆç¾é£Ÿæ¨è
   * @param preferences ç”¨æˆ·åå¥½
   * @returns ç¾é£Ÿæ¨èå†…å®¹
   */
  static async generateFoodRecommendation(
    preferences?: string
  ): Promise<string> {
    const context = `å¹³æ½­ç‰¹è‰²ç¾é£ŸåŒ…æ‹¬ï¼š
- å¹³æ½­é±¼ä¸¸ï¼šQå¼¹çˆ½æ»‘çš„ä¼ ç»Ÿå°åƒ
- æµ·è›ç…ï¼šæ–°é²œæµ·è›åˆ¶ä½œçš„ç…é¥¼
- ç´«èœåŒ…é¥­ï¼šå½“åœ°ç‰¹è‰²ç´«èœæ–™ç†
- æµ·é²œå¤§é¤ï¼šæ–°é²œçš„èƒèŸ¹ã€è™¾ã€é±¼ç±»
- å¹³æ½­ç±³ç²‰ï¼šå½“åœ°ä¼ ç»Ÿä¸»é£Ÿ
- èŠ±ç”Ÿæ±¤ï¼šç”œå“å°é£Ÿ`;
    
    const message = preferences 
      ? `è¯·æ ¹æ®æˆ‘çš„å£å‘³åå¥½æ¨èå¹³æ½­ç¾é£Ÿï¼š${preferences}`
      : 'è¯·æ¨èå¹³æ½­çš„ç‰¹è‰²ç¾é£Ÿ';
    
    return this.generateResponse(message, context);
  }

  /**
   * ç”Ÿæˆä½å®¿æ¨è
   * @param budget é¢„ç®—èŒƒå›´
   * @param location ä½ç½®åå¥½
   * @returns ä½å®¿æ¨èå†…å®¹
   */
  static async generateAccommodationRecommendation(
    budget?: string,
    location?: string
  ): Promise<string> {
    const context = `å¹³æ½­ä½å®¿é€‰æ‹©åŒ…æ‹¬ï¼š
- æµ·æ™¯é…’åº—ï¼šé¢æœå¤§æµ·çš„é«˜ç«¯é…’åº—
- æ°‘å®¿å®¢æ ˆï¼šä½“éªŒå½“åœ°æ–‡åŒ–çš„ç‰¹è‰²ä½å®¿
- åº¦å‡æ‘ï¼šè®¾æ–½å®Œå–„çš„åº¦å‡å‹é…’åº—
- é’å¹´æ—…ç¤¾ï¼šç»æµå®æƒ çš„èƒŒåŒ…å®¢é€‰æ‹©
- æ¸”å®¶ä¹ï¼šä½“éªŒæ¸”æ°‘ç”Ÿæ´»çš„ç‰¹è‰²ä½å®¿`;
    
    let message = 'è¯·æ¨èå¹³æ½­çš„ä½å®¿é€‰æ‹©';
    if (budget || location) {
      message += 'ï¼Œæˆ‘çš„è¦æ±‚æ˜¯ï¼š';
      if (budget) message += `é¢„ç®—${budget}`;
      if (location) message += `${budget ? 'ï¼Œ' : ''}ä½ç½®åå¥½${location}`;
    }
    
    return this.generateResponse(message, context);
  }

  /**
   * ç”Ÿæˆè¡Œç¨‹æ¨è
   * @param days æ—…æ¸¸å¤©æ•°
   * @param interests å…´è¶£åå¥½
   * @returns è¡Œç¨‹æ¨èå†…å®¹
   */
  static async generateItineraryRecommendation(
    days?: number,
    interests?: string
  ): Promise<string> {
    const context = `å¹³æ½­æ—…æ¸¸å»ºè®®ï¼š
- 1-2å¤©ï¼šå›å—æ¹¾ + çŸ³ç‰Œæ´‹ + é¾™å‡¤å¤´æµ·æ»¨æµ´åœº
- 3-4å¤©ï¼šå¢åŠ åŒ—æ¸¯æ‘ + çŒ´ç ”å²› + ä¸œæµ·ä»™å¢ƒ
- 5å¤©ä»¥ä¸Šï¼šå¯ä»¥æ·±åº¦ä½“éªŒæ¸”å®¶æ–‡åŒ–ï¼Œå‚åŠ æµ·ä¸Šæ´»åŠ¨

æœ€ä½³æ—…æ¸¸æ—¶é—´ï¼š4-10æœˆï¼Œå¤©æ°”æ¸©å’Œï¼Œé€‚åˆæµ·æ»¨æ´»åŠ¨`;
    
    let message = 'è¯·ä¸ºæˆ‘åˆ¶å®šå¹³æ½­æ—…æ¸¸è¡Œç¨‹';
    if (days || interests) {
      message += 'ï¼Œæˆ‘çš„æƒ…å†µæ˜¯ï¼š';
      if (days) message += `è®¡åˆ’æ¸¸ç©${days}å¤©`;
      if (interests) message += `${days ? 'ï¼Œ' : ''}å…´è¶£åå¥½ï¼š${interests}`;
    }
    
    return this.generateResponse(message, context);
  }
}